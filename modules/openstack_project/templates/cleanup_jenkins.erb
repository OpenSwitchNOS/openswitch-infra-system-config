#!/bin/bash

echo "Cleaning the server ..."
echo

echo 'Waiting for node to be idle'
echo
while ! curl -s -k -X POST https://jenkins.openhalon.io/computer/<%=slave%>/api/xml | grep -q '<idle>true</idle>'; do
    sleep 10;
done

echo "Node is now idle, setting it offline..."
echo
curl -s -X POST -u gerrig:<%=token%> https://jenkins.openhalon.io/computer/<%=slave%>/toggleOffline?offlineMessage="Performing%20daily%20maintenance"

echo 'Waiting for node to be idle again (just in case)'
echo
while ! curl -s -k -X POST https://jenkins.openhalon.io/computer/<%=slave%>/api/xml | grep -q '<idle>true</idle>'; do
    sleep 5;
done

echo 'The node is idle now. Cleaning up the Jenkins Workspace'
echo
rm -rf /mnt/jenkins/workspace

echo "Setting the node back online.."
echo
curl -s -X POST -u gerrig:<%=token%> https://jenkins.openhalon.io/computer/<%=slave%>/toggleOffline

echo "Cleanup completed"
